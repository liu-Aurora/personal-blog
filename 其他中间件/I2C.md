# I2C通信协议

## 一、 概述

>IIC 协议（***Inter-Integrated Circuit***，可简写为 ***I2C***），是一种用于各种电子设备之间进行通信和[数据交换](https://so.csdn.net/so/search?q=数据交换&spm=1001.2101.3001.7020)的串行通信协议。它是由飞利浦（Philips）公司于 1982 年首次提出并推广的一种简单、高效、低成本的通信协议。
>
> 
>
>I2C 协议采用双线结构传输数据，包括一个数据线和一个时钟线（即 SDA 和 SCL 线），其中 SDA（Serial Data）线用于双向数据传输，而 SCL（Serial Clock）线则用于同步数据传输的时钟信号。通信始终由主设备（Master）控制，从设备（Slave）被动接收和回应。这种简单的线路连接方式使得设备之间的互连变得非常容易
>

## 二、I2C协议

### 1、I2C总线结构图

![image-20240908210051318](D:\markdown\其他中间件\assets\image-20240908210051318.png)	

- 由时钟线SCL和数据线SDA组成，并且都接上拉电阻，确保总线空闲状态为高电平
- 总线支持多设备连接，允许多主机存在，每个设备都有一个唯一的地址
- 主机有权发起和结束一次通信，从机只能被动呼叫；
- 当总线上有多个主机同时启用总线时，`I2C` 也具备冲突检测和仲裁的功能来防止错误产生；
- 每个连接到 `I2C` 总线上的器件都有一个唯一的地址（7 bit），且每个器件都可以作为主机也可以作为从机（但同一时刻只能有一个主机），总线上的器件增加和删除不影响其他器件正常工作；
- 连接到总线上的数目受总线的最大电容400pf限制
- 数据传输速率：标准模式100k bit/s  快速模式400k bit/s 高速模式3.4Mbit/s

### 2、通信引脚采用开漏输出

**开漏输出的好处：** 主要避免MCU输入和输出来回切换，通过开漏输出，将总线释放，再读取总线来实现输入

1. **电平兼容性:**
   - 开漏输出本身 **不输出高电平**，只负责将输出拉低到地电位。
   - 通过 **外部上拉电阻** 连接到不同的电源电压，可以灵活地适配不同的逻辑电平标准，实现与不同电压设备的互联。
   - 避免了电平转换电路的需求，简化了设计。
2. **多设备共享 (线与):**
   - 多个开漏输出可以连接到同一条线上，实现 **线与** 的逻辑功能。
   - 只有当所有连接到该线的设备输出都为高电平 (即都不拉低) 时，线上才会呈现高电平。
   - 只要有一个设备输出低电平 (拉低)，线上就会呈现低电平。
   - 这种特性非常适合 **总线系统** 和 **多主设备** 的应用场景，例如 I2C 和 SPI 总线。
3. **容错性:**
   - 多个开漏输出连接到同一条线时，即使多个设备同时尝试拉低输出，也不会造成 **电流冲突** 或损坏设备。
   - 这是因为每个开漏输出都 **通过独立的电阻** 连接到地，限制了电流。
4. **灵活的逻辑控制:**
   - 开漏输出可以与其他逻辑门电路组合，实现更复杂的逻辑功能。
   - 例如，可以将多个开漏输出连接到一个与门，实现 **线与** 功能。



> **在 I2C 总线中，不参与通信的从机应该处于 高阻态，也称为 释放总线。**
>
> 这意味着从机的 SDA 和 SCL 引脚既不输出高电平，也不输出低电平，而是呈现高阻抗状态，允许其他设备控制总线。
>
> 总线是否处于低电平取决于 **当前正在通信的设备**。当某个设备需要发送数据时，它会将 SDA 或 SCL 拉低到低电平。如果所有设备都处于高阻态，则总线会通过上拉电阻保持在高电平。



>**为什么不会造成电流冲突或损坏设备？****1. 电流路径独立:**
>
>每个开漏输出都通过一个独立的 **上拉电阻** 连接到电源电压。当某个设备尝试拉低输出时，电流会从电源流经上拉电阻，再流经该设备内部的 MOSFET 到地。
>
>由于每个设备都有自己的电流路径，即使多个设备同时拉低输出，电流也不会在设备之间流动，而是分别流经各自的路径。
>
>**2. 电阻限流:**
>
>上拉电阻的存在限制了流过每个设备的电流大小。即使多个设备同时拉低输出，总电流也不会超过电源电压除以上拉电阻阻值的数值。
>
>例如，如果电源电压为 5V，上拉电阻为 1kΩ，那么即使 10 个设备同时拉低输出，总电流也只有 5mA，不会对设备造成损坏。
>
>**3. MOSFET 的保护作用:**
>
>开漏输出通常使用 MOSFET 作为输出级。MOSFET 具有 **电流限制** 和 **过热保护** 功能，可以防止电流过大或温度过高损坏设备。

### 3、I2C 协议时序

![image-20240908215130783](D:\markdown\其他中间件\assets\image-20240908215130783.png)

 **起始位**：在 SCL 为高电平的时候，SDA 出现下降沿就表示为起始位

**停止位**： 在 SCL 位高电平的时候，SDA 出现上升沿就表示为停止位

 **数据传输**：I2C 总线在数据传输的时候要保证在 SCL 高电平期间，SDA 上的数据稳定，即 SDA 上的数据变化只能在 SCL 低电平期间发生

**应答信号**：当 I2C主机发送完 8 位数据以后会将 **SDA 设置为输入状态**（主机释放SDA总线给从机），等待 `I2C` 从机应答，也就是等到 `I2C` 从机告诉主机它接收到数据了。从机拉低SDA就是确认收到数据即ACK，否则NACK

### 4、I2C读/写时序

> **I2C 写时序**：要在 `I2C` 总线上写入，主机将在总线上发送：一个启动开始标志、从机地址、最后一位（R/W位）设置为 0，这表示写入。从设备发送 ACK 响应确认后，主设备将发送其希望写入的寄存器的寄存器地址。从设备将再次确认，让主设备知道它已准备就绪。在此之后，主机将开始向从机发送寄存器数据，直到主机发送了它需要的所有数据（有时这只是一个字节），并且主机将以停止条件终止传输。AA

![image-20240908215929422](D:\markdown\其他中间件\assets\image-20240908215929422.png)

>  **I2C 读时序**：主机为了读取从设备的数据，主机必须首先指出希望从从设备的哪个寄存器读取数据。这是由主机写入从设备的“写操作”类似的方式开始传输，通过发送 R/W 位等于 0 的地址（表示写入），然后是它希望从中读取的寄存器地址来完成的。

****

![image-20240908220017682](D:\markdown\其他中间件\assets\image-20240908220017682.png)