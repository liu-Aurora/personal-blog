# MQTT协议入门

## 一、MQTT协议概念

###  1.MQTT简介

>简介：MQTT(Message Queuing Telemetry Transport, 消息队列遥测传输协议)，是一种基于发布/订阅(publish/subscribe)模式的"轻量级"通讯协议，该协议构建于TCP/IP协议上，由IBM在1999年发布。MQTT最大优点在于，可以以极少的代码和有限的带宽，为远程连接设备提过实时可靠的消息服务，作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用
>
>MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如:机器与机器（M2M）通信和物联网(loT)。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用

### 2.MQTT特点

>MQTT是基于Publish/Subscribe(发布订阅)模式的物联网通信协议特点:
>
>1. 简单易实现
>2. 支持Qos(服务质量)
>3. 报文小MQTT协议构建于TCP/IP协议之上

**发布订阅模式**: 客户端只需要订阅这个主题，当有其他客户端向这个服务端发布消息时，这个客户端就可以收到这个消息

![img](https://i-blog.csdnimg.cn/blog_migrate/a71ee5a7dc64d80e3d04dd7b2c964a2e.png)	

**请求响应模式**

![img](https://i-blog.csdnimg.cn/blog_migrate/3ece052f588cb3739fe4c611f34c6704.png)	

### 3.MQTT协议主要特性

- (1）开放消息协议，简单易实现。
- (2）使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。
- (3）对负载（协议携带的应用数据）内容屏蔽的消息传输。
- (4）基于TCP/IP网络连接,提供有序，无损，双向连接。
  主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。
  由于基于不同的连接方式，优缺点自然也就各有不同了。
- (5）消息服务质量(QoS）支持，可靠传输保证;有三种消息发布服务质量:
  QoSO:“至多一次”，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。
  QoS1:“至少—次”，确保消息到达，但消息重复可能会发生。
  QoS2:“只有一次”，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。
- (6) 1字节固定报头，2字节心跳报文，最小化传输开销和协议交换，有效减少网络流量。
  这就是为什么在介绍里说它非常适合"在物联网领域，传感器与服务器的通信，信息的收集，要知道嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了。。

## 二、MQTT协议原理

### 1.MQTT协议实现方式

> 实现MQTT协议需要客户端和服务器端通讯完成， 在通讯过程中, MQTT协议中有三种身份: 发布者(Publish)、代理(Broker)(服务器)、订阅者(Subscribe)。 其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

>MQTT会构建底层网络传输: 它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。

![img](https://i-blog.csdnimg.cn/blog_migrate/0117120abcfb979ce13291fefd668bc8.png)	

>MQTT传输的消息分为: 主题(Topic) 和 负载(payload)两部分:
>
>\- (1) Topic: 可以理解为消息的类型，订阅者订阅(Subscribe)后，就会收到该主题的消息内容(payload)
>\- (2) payload: 可以理解为消息的内容，是指订阅者具体要使用的内容

### 2.MQTT客户端

>一个使用MQTT协议的应用程序或者设备，它总是建立到服务器的网络连接。

- (1) 发布其他客户端可能会订阅的信息
- (2) 订阅其他客户端发布的消息
- (3) 退定或删除应用程序的消息
- (4) 断开与服务器的连接

### 3.MQTT服务器端

> MQTT服务器以称为"消息代理"(Broker), 可以是一个应用程序或一台设备，它是位于消息发布者和订阅者之间

- (1) 接受来自客户的网络连接;
- (2) 接受客户发布的应用信息
- (3) 处理来自客户端的订阅和退订请求
- (4) 向订阅的客户转发应用程序消息

### 4.发布/订阅、主题、会话

> MQTT是基于**发布(Publish)/订阅(Subscribe)**模式来进行通信及数据交换的，与HTTP的**请求(Request)/应答(Response)**的模式有本质的不同

**订阅者(Subscriber)**会向 **消息服务器(Broker)**订阅一个**主题(Topic)**。成功订阅后，消息服务器会将该主题下的消息转发给所有订阅者
主题(Topic)以’/‘为分隔符区分不同的层级，包含通配符’+’ 或 ‘#’的主题又称为**主题过滤器(Topic Filters);** 不含通配符的成为**主题名(Topic Names)**

**发布者(Publisher)**只能向主题名发布消息，订阅者(Subscriber)则可以通过订阅主题过滤器来通配多个主题名称

**会话(Session)**每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。