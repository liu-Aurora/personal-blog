# FSMC/FMC存储控制器

## 一、FSMC概述

>**FSMC( Flexible static memory controller)**全称“灵活的静态存储器控制器”，是 STM32中一个很有特色的外设，通过 FSMC，STM32可以**通过FSMC与SRAM、ROM、PSRAM、Nor Flash和NandFlash存储器**的引脚相连，从而**进行数据的交换**。
>
>要注意的是，**FSMC 只能扩展静态的内存**，即名称里面的 S：static，不能是动态的内存，比如 SDRAM 就不能扩展。

**FSMC作用：**

例：stm32有存储器，它可以接外部存储器，来扩展内存的，那么这种外接存储器，该**如何进行通信**呢？

>**单片机跟外部存储器通信：**首先要知道存储器的存储地址，单片机根据地址将数据传输指定地址，整体需要的是通信协议。
>
>通信协议：同步/异步，是否分地址/数据总线---------整个通信时序是什么？
>
>DRAM存取分地址/数据总线，地址标志的存储的地方，数据标志存储的内容。
>
>AT24C02不分地址/数据总线，根据芯片通信内容来区分数据和地址。
>
>FSMC本质就是抽象化底层，它就是完成通信协议的外设，只需要对地址、数据总线，进行输入\输出即可。

## 二、FMC通信引脚

![image-20240917131416246](D:\markdown\其他中间件\assets\image-20240917131416246.png)

这里以驱动LCD为例：**FMC模拟8080时序---通信引脚对比**

FMC_NE     -------    CS  （片选）			    	 	FM_A[25:0]   -------   LCD_RS（数据/命令线）

FMC_NOE   ------   LCD_RD（读写使能，上升沿有效）	FMC_NWE     -----     LCD_WR（写使能，上升沿有效）

FMC_D[31:0] ----- LCD[0:15] （数据传输）

**正常通过IO口的时序逻辑跟DRAM通信是非常繁琐的**

> **STM32自带的FSMC功能，就是专门为这类存储器设计的**，只要外部的DRAM等存储器将对应的数据线连接到STM32这些对应的引脚上，引脚功能设置为复用模式，**通过配置FSMC** ，你可以直接给上面那个固定的地址赋值 ，**其他操作STM32都会自动给你完成，就可以把数据存储到SRAM中**

## 三、FSMC 框图

<img src="D:\markdown\其他中间件\assets\image-20240917134259209.png" alt="image-20240917134259209" style="zoom:80%;" />	

**第一部分：**

在框图的右侧是FSMC外设相关的控制引脚，控制不同类型存储器的时候会有一些不同的引脚，其中**地址线FSMC_A和数据线FSMC_D是所有控制器都共用的**

NOR/SRAM信号 ：这部分是**NOR 和SRAM这类存储器的控制信号**，其中：

- FSMC_CLK是时钟信号
- FSMC_NE[4:0]是片选信号 选择SRAM的不同存储区域
- FSMC_NBL[1:0] 是数据掩码
- FSMC_NL是输入地址是否有效

**第二部分**

FSMC是由AHB总线控制配置寄存器来设置的：
**NOR/PSRAM/SRAM 设备使用相同的控制器，NAND/PC 卡设备使用相同的控制器，不同的控制器有专用的寄存器用于配置其工作模式。每种寄存器都有 4 个，分别对应于 4 个不同的存储区域。**

- 控制 NOR FLASH 的有 FSMC_BCR1/2/3/4 控制寄存器、FSMC_BTR1/2/3/4 片选时序寄存器以及 FSMC_BWTR1/2/3/4 写时序寄存器。
- FSMC_BCR 控制寄存器可配置要控制的存储器类型、数据线宽度以及信号有效极性能参数。
- FMC_BTR 时序寄存器用于配置 SRAM 访问时的各种时间延迟，如数据保持时间、地址保持时间等。
- FMC_BWTR 写时序寄存器与 FMC_BTR 寄存器控制的参数类似，它专门用于控制写时序的时间参数

**第三部分**

**FSMC 外设挂载在 AHB 总线上，时钟信号来自于 HCLK(默认 72MHz)，控制器的同步时钟输出就是由它分频得到。**

- 它可用于与**同步类型**的 NOR FLASH 芯片通过FSMC_CLK 引脚输出进行**同步通讯**，
- 对于**异步类型**的存储器，不使用同步时钟信号，所以时钟分频配置不起作用

**FSMC 四种模式：**FSMC本质就是模拟通信时序，来抽象底层通信协议。对于存储器有异步和同步等不同通信协议。

**异步\同步工作模式：**

- 同步突发访问中获得第 1 个数据所需要的等待延迟(DATLAT)
- 异步突发访问方式，FSMC 主要设置 3 个时间参数：地址建立时间(ADDSET)、数据建立时间(DATAST)和地址保持时间(ADDHLD)。

**FSMC 外设支持输出多种不同的时序**，选用不同的时序模型时，需要设置不同的时序参数，**满足存储器读写时序不一样需求**

![image-20240917150551636](D:\markdown\其他中间件\assets\image-20240917150551636.png)

## 四、FMC地址映射

>**FSMC 连接好外部的存储器并初始化后，就可以直接通过访问地址来读写数据 其中这部分在内存中有着固定的存储地址，存储单元是映射到 STM32 的内部寻址空间**

**FSMC的映射工作实现：FSMC 的地址映射机制可以理解为一个简单的地址偏移**

- 当你访问 STM32 的内部地址 0x60000000 时，FSMC 会将其转换为外部 SRAM 的地址 0x000000。
- 这个转换过程就是将 STM32 的内部地址减去 FSMC Bank1 的起始地址（0x60000000 - 0x60000000 = 0x000000）。

**例如：**

如果你将一块 1MB 的 SRAM 连接到 FSMC Bank1，并将 Bank1 的起始地址配置为 0x60000000，数据宽度配置为 16 位。那么：

- 外部 SRAM 的地址 0x000000 就会映射到 STM32 的内部地址 0x60000000。
- 外部 SRAM 的地址 0x000001 就会映射到 STM32 的内部地址 0x60000002（因为数据宽度是 16 位）。
- 外部 SRAM 的地址 0x000002 就会映射到 STM32 的内部地址 0x60000004。

<img src="D:\markdown\其他中间件\assets\image-20240917160223859.png" alt="image-20240917160223859" style="zoom: 80%;" />	

**也就是从0x6000 0000 到0x9FFF FFFF 这1.0GB大小的空间被作为FMC的地址**，这些地址是没有对应的寄存器的，**将它们映射到存储器是，就有了响应的寄存器**



**FSMC 把整个 存储区域分成了 4 个 Bank 区域，NOR 及 SRAM 存储器只能使用 Bank1 的地址，在每个 Bank 的内部又分成了 4 个小块，每个小块有相应的控制引脚用于连接片选信号FSMC_NE1/2/3/4**

当 STM32 访问0x6C000000-0x6FFFFFFF 地址空间时，其实就是访问FSMC BANK1的第一块区域，FSMC_NE1 引脚会自动设置为低电平

![image-20240917160610639](D:\markdown\其他中间件\assets\image-20240917160610639.png)

**具体是选择那个小快，由地址线（ADDR[27:26]）寻址确定**

![img](D:\markdown\其他中间件\assets\dc409f627219e0177cb9b310180c263c.png)	

**Bank1的256M字节空间由`28根地址线`（ADDR[27:0]）寻址**。这里ADDR 是内部AHB地址总线，其中`ADDR[25:0]`对应外部存储器地址`FSMC_A[25:0]`，而HADDR[26:27]对4个区进行寻址

**这里要注意的是FSMC中每一个地址，对应的是存储器中的一个字节**

假设我们用BANK1的区1，那么0x6000 0000-0x63ff ffff (共64M个字节byte地址) 对应的就是存储器的地址就是64Mx8=512M地址

**问题背景：**

- FSMC的地址线是按字节寻址的，例如BANK1的区1地址范围是0x6000 0000 - 0x63FF FFFF，共64M个字节地址。
- 某些存储器，例如16位宽度的NOR Flash，不支持单字节访问，只能以16位或32位的宽度进行读写。
- 如果直接使用FSMC的字节地址访问16位宽度的存储器，会导致地址错位，例如写入一个字节的数据，实际上会修改两个连续的字节。

**FMC的解决方案：**

为了解决这个问题，FMC采用了一种地址“措位”的机制：

1. **丢弃最低位:** FMC内部将地址线ADDR[25:0]的最低位（bit-0）丢弃，不再连接到外部存储器的地址引脚FMC_A上。
2. **从bit-1开始计数:** FMC从地址线的bit-1开始对地址进行计数，相当于只访问偶数地址。

**效果：**

- 对于16位宽度的存储器，原本64M个字节地址变成了32M个双字节地址，每个地址对应存储器中的两个字节。
- 这样，FSMC就可以通过访问偶数地址来正确地读写16位宽度的存储器，避免了地址错位的问题。

**举例说明：**

假设要访问16位NOR Flash的地址0x0000，使用FMC的措位机制后，实际访问的地址是：

- FMC内部地址：0x0000
- 丢弃bit-0：0x0000 丢弃位:0:0x0000
- FMC_A地址引脚输出：0x0000

假设要访问16位NOR Flash的地址0x0001，使用FMC的措位机制后，实际访问的地址是：

- FMC内部地址：0x0001
- 丢弃bit-0：0x0000 丢弃位:0:0x0000
- FMC_A地址引脚输出：0x0000

可以看到，访问0x0000和0x0001都会映射到NOR Flash的同一个地址0x0000，因为NOR Flash只能以双字节为单位进行访问。

## 五、FSMC寄存器

**FMC相关寄存器介绍**

> 对于NOR_FLASH/PSRAM控制器(存储块1)配置工作，通过FMC_BCRx、FMC_BTRx和FMC_BWTRx寄存器设置（其中x=1~4，对应4个区）。

![image-20240918144716453](D:\markdown\其他中间件\assets\image-20240918144716453.png)

**SRAM/NOR闪存片选控制寄存器（FMC_BCRx）**

![image-20240918144803739](D:\markdown\其他中间件\assets\image-20240918144803739.png)

**SRAM/NOR闪存片选时序寄存器（FMC_BTRx）**

![image-20240918145007510](D:\markdown\其他中间件\assets\image-20240918145007510.png)

**SRAM/NOR闪存写入时序寄存器（FMC_BWTRx）**

![image-20240918145118866](D:\markdown\其他中间件\assets\image-20240918145118866.png)

 **FSMC参数设置**

![image-20240917151222380](D:\markdown\其他中间件\assets\image-20240917151222380.png)

## 六、HAL库配置FMC







## 七、总结

**FSMC的功能总结：**

> 将AHB传输信号转换到适当的外部设备协议；满足访问外部设备的时序要求。
> 所有的外部存储器共享控制器输出的地址、数据和控制信号，每个外部设备可以通过一个唯一的片选信号加以区分。FSMC在任一时刻只访问一个外部设备。

- **地址映射：** 将外部存储器的地址空间映射到 STM32 的内部地址空间。
- **时序控制：** 根据外部存储器的特性，配置访问时序参数（例如读写周期、等待时间等），确保可靠的通信。
- **信号控制：** 控制片选信号、读写使能信号等，协调 STM32 与外部存储器之间的数据传输。
- **数据宽度控制：** 支持 8 位、16 位或 32 位的数据宽度，适应不同类型的外部存储器。

**FSMC的特点**

- 1、 FSMC的一大特点是支持不同位宽的异步读写操作。

- 2、 FSMC的映射地址空间中，不同的BANK是独立的，可用于扩展不同类型的存储器。当FSMC同时使用多个外部存储器时，FSMC会通过总线悬空延时时间参数，来防止访问冲突发生。

- 3、 支持代码从FSMC扩展的外部存储器中直接运行。不需要首先调入内部SRAM。
