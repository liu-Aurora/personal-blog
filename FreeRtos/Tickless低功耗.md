# Tickless低功耗模式

## 一、  STM32低功耗模式

**三种低功耗模式**：睡眠模式、停止模式、待机模式。

**低功耗模式进入与退出**：

<img src="C:\Users\15924\AppData\Roaming\Typora\typora-user-images\image-20240807225206787.png" alt="image-20240807225206787" style="zoom:67%;" />	

---

## 二、Tickless低功耗模式

>**实现Tickless低功耗的问题**：
>
>1、进入低功耗之后，多久唤醒？也就是下一个要运行的任务如何被准确唤醒
>
>2、任何中断均可唤醒MCU，若滴答定时器频繁中断则会影响低功耗的效果？
>
>>将滴答定时器的中断周期修改为低功耗运行时间
>>
>>退出低功耗后，需补上系统时钟节拍数

> **Tickless本质:**
>
> 调用指令WFI实现睡眠模式，在整个系统的运行过程中，其实大部分时间是在执行空闲任务的，所以在空闲的时候进入低功耗，在其他任务准备运行的时候再退出低功耗模式。

> **运行方式:**
>
> 进入低功耗后，获取到下一个任务的进入时间，就设置低功耗的退出时间，为了防止滴答定时器的中断唤醒MCU，频繁中断影响效果，将滴答定时器的中断周期修改为低功耗的运行时间，退出低功耗模式后，再补上节拍数

>由于必须定期退出然后重新进入低功耗状态以处理滴答中断， **这种简单方法所能实现的节能效果是有限的 。此外，如果滴答中断的频率太高，会使得没有效果**。 所以FreeRTOS 在闲置期间（没有可执行的应用程序任务的期间） 停止周期性滴答中断， 然后，在滴答中断重启时，对 RTOS 滴答计数值 进行校正调整。 **通过停止滴答中断**，微控制器可以维持在深度节能状态， **直到中断发生**，或者到了 RTOS 内核 将任务转换为“就绪”状态的时间
>

## 三、Tickless模式相关配置项

**需要系统运行低功耗模式需满足以下几个条件**

- 在 FreeRTOSConfig.h 文件中配置宏定义 **configUSE_TICKLESS_IDLE 为 1** 
- 满足当前空闲任务正在运行，所有其他任务处在挂起状态或阻塞状态
- 当系统可运行于低功耗模式的时钟节拍数大于等于 **configEXPECTED_IDLE_TIME_BEFORE_SLEEP**（该宏默认为2个系统时钟节拍）

**若想系统进入低功耗时功耗达到最低**

- 在进入睡眠模式前，可以关闭外设时钟、降低系统主频等，进一步降低系统功耗

>调用函数configPRE_SLEEP_RPOCESSING()，需自行实现该函数的内部操作

- 退出睡眠模式后，开启前面所关闭的外设时钟、恢复系统时钟主频等

>调用函数l configPOSR_SLEEP_PROCESSING(x) ，需自行实现该函数的内部操
